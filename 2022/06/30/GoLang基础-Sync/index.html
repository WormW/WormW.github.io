<!DOCTYPE html>
<html lang=zh-CN>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta property="og:description" content="">
    <meta property="og:type" content="website">
    <meta name="description" content="">
    <meta name="keyword"  content="">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>
        
        GoLang基础-Sync - undefined
        
    </title>

    <!-- Custom CSS -->
    
<link rel="stylesheet" href="/css/aircloud.css">

    
<link rel="stylesheet" href="/css/gitment.css">

    <!--<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">-->
    <link href="//at.alicdn.com/t/font_620856_28hi1hpxx24.css" rel="stylesheet" type="text/css">
    <!-- ga & ba script hoook -->
    <script></script>
<meta name="generator" content="Hexo 6.2.0"></head>

<body>

<div class="site-nav-toggle" id="site-nav-toggle">
    <button>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
    </button>
</div>

<div class="index-about">
    <i>  </i>
</div>

<div class="index-container">
    
    <div class="index-left">
        
<div class="nav" id="nav">
    <div class="avatar-name">
        <div class="avatar radius">
            <img src="//cdn.v2ex.com/gravatar/67de7a44872c4772b2838897a6cee124?s=200" />
        </div>
        <div class="name">
            <i>WormW</i>
        </div>
    </div>
    <div class="contents" id="nav-content">
        <ul>
            <li >
                <a href="/">
                    <i class="iconfont icon-shouye1"></i>
                    <span>HOME</span>
                </a>
            </li>
            <li >
                <a href="/tags">
                    <i class="iconfont icon-biaoqian1"></i>
                    <span>TAGS</span>
                </a>
            </li>
            <li >
                <a href="/archives">
                    <i class="iconfont icon-guidang2"></i>
                    <span>ARCHIVES</span>
                </a>
            </li>
            <li >
                <a href="/collect/">
                    <i class="iconfont icon-shoucang1"></i>
                    <span>COLLECT</span>
                </a>
            </li>
            <li >
                <a href="/about/">
                    <i class="iconfont icon-guanyu2"></i>
                    <span>ABOUT</span>
                </a>
            </li>
            
            <li>
                <a id="search">
                    <i class="iconfont icon-sousuo1"></i>
                    <span>SEARCH</span>
                </a>
            </li>
            
        </ul>
    </div>
    
        <div id="toc" class="toc-article">
    
</div>
    
</div>


<div class="search-field" id="search-field">
    <div class="search-bg" id="search-bg"></div>
    <div class="search-container">
        <div class="search-input">
            <span id="esc-search"> <i class="icon-fanhui iconfont"></i></span>
            <input id="search-input"/>
            <span id="begin-search">search</span>
        </div>
        <div class="search-result-container" id="search-result-container">

        </div>
    </div>
</div>

        <div class="index-about-mobile">
            <i>  </i>
        </div>
    </div>
    
    <div class="index-middle">
        <!-- Main Content -->
        


<div class="post-container">
    <div class="post-title">
        GoLang基础-Sync
    </div>

    <div class="post-meta">
        <span class="attr">Post：<span>2022-06-30 00:22:01</span></span>
        
        <span class="attr">Tags：/
        
        <a class="tag" href="/tags/#golang" title="golang">golang</a>
        <span>/</span>
        
        <a class="tag" href="/tags/#基础" title="基础">基础</a>
        <span>/</span>
        
        
        </span>
        <span class="attr">Visit：<span id="busuanzi_value_page_pv"></span>
</span>
</span>
    </div>
    <div class="post-content ">
        <ol>
<li><p>使用锁保护happens before需要使用锁保护</p>
</li>
<li><p>尽量使用chan通信（但是chan底层也是通过互斥锁实现，只是更加简洁）</p>
</li>
<li><p>data race</p>
<ol>
<li>go build -race</li>
<li>多个goroutine共享全局变量时会出现的问题</li>
<li>data race的判断要根据 原子性 和 可见性</li>
</ol>
</li>
<li><p>interface底层时2个machine word</p>
</li>
<li><p>map是原子赋值，但是也存在data race</p>
</li>
<li><p>**<code>atomic.Value</code>**可以解决赋值的多步骤问题，本质上是通过将两步赋值拆开，检查第二步的赋值结果来验证赋值成功，在成功前不返回结果，隐藏中间态</p>
</li>
<li><p>也可以使用RWMutex锁，读多写少时 atomic.value效率会高很多</p>
</li>
<li><p>copy on write-不修改老对象，复制新对象，然后修改，最后替换</p>
</li>
<li><p>Mutex锁实现</p>
<ol>
<li>barging ，锁释放后会唤醒第一个等待者，但是拿到锁的人可能是第一个等待着或者第一个请求者</li>
<li>handsoff，等待等待者被唤醒后交接锁，释放锁的实际会更晚，降低了吞吐量</li>
<li>spinning，自选锁的等待着会一直循环查询，而不会进入parking状态，也不会有被唤醒的过程</li>
<li>go1.8中使用barging和spining结合地方方式，试图获取已经被持有的锁事，如果本地队列位空并且P的数量大于1，goroutine会自旋几次（用一个P旋转会阻塞程序），尝试几次后进入park状态（用cpu换时间）</li>
<li>go1.9中增加了饥饿模式，释放时会触发handoff，将等待超过1ms的goroutine（有界等待）标记为饥饿，unlock方法会handoff把锁交给第一个等待者，饥饿模式下自旋会被停用，因为传入goroutines没有机会获取下一个等待着保留的锁（自旋一直在抢占锁）</li>
</ol>
</li>
<li><p>errgroup原理，底层通过waitgroup实现，</p>
<ol>
<li><p>主要是取出了waitgroup中没有拿到的错误值</p>
</li>
<li><p>返回错误值之后，会填充到结构体的err属性里，可以通过wait获取</p>
</li>
<li><p>通过sem 这个chan进行限流</p>
</li>
<li><p>具体的内部实现在Go函数&#x2F;TryGo函数</p>
<ol>
<li>go会直接往sem里塞入（无返回值）&#x2F;TryGo会（有返回值）如果超过限流直接返回false</li>
<li>内部使用wg.Add wg.Done控制状态</li>
<li>使用errOnce.Do做一个原子执行，内部使用atomic实现</li>
<li>只有第一次报错的goroutine可以调用成功</li>
</ol>
</li>
</ol>
</li>
<li><p>sync.Pool</p>
<ol>
<li><p>pool内的东西可能会被随时回收，所以不能放状态的连接</p>
</li>
<li><p>应该尽量放入无状态数据</p>
</li>
<li><p>go1.13引入了victim cache，会将pool内数据拷贝一份，避免gc晴空，即使没有饮用的内容也可以保留最多两轮GC</p>
</li>
<li><p>使用pool减少重复构建某些重用结构体</p>
<ol>
<li><p>具体使用gin的coutext</p>
<ol>
<li><pre><code>pool.Get().(*Context)
</code></pre>
</li>
</ol>
</li>
<li><p>fmt.printf newPrinter</p>
</li>
</ol>
</li>
</ol>
</li>
</ol>

        
        <br />
        <div id="comment-container">
        </div>
        <div id="disqus_thread"></div>
        <div id="lv-container"></div>
        <div class="giscus"></div>
    </div>
</div>

    </div>
</div>


<footer class="footer">
    <ul class="list-inline text-center">
        
        

        

        

        

        

    </ul>
    
    <p>
        <span id="busuanzi_container_site_pv">
            <span id="busuanzi_value_site_pv"></span>PV
        </span>
        <span id="busuanzi_container_site_uv">
            <span id="busuanzi_value_site_uv"></span>UV
        </span>
        Created By <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a>  Theme <a target="_blank" rel="noopener" href="https://github.com/aircloud/hexo-theme-aircloud">AirCloud</a></p>
</footer>




</body>

<script>
    // We expose some of the variables needed by the front end
    window.hexo_search_path = "search.json"
    window.hexo_root = "/"
    window.isPost = true
</script>
<script src="//cdn.bootcdn.net/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

<script src="/js/index.js"></script>

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>






</html>
